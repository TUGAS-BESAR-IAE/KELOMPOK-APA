{% extends "layout.html" %}

{% block title %}Order Management{% endblock %}

{% block content %}
<div class="container">
    <!-- Add Order Form -->
    <div class="add-order-form card shadow-sm mb-4">
        <div class="card-body">
            <h3 class="card-title mb-4">Add New Order</h3>
            <form id="orderForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="customer" class="form-label">Customer</label>
                        <select class="form-control" id="customer" name="customer" required>
                            <option value="">Select Customer</option>
                        </select>
                    </div>
                </div>

                <div id="orderItems">
                    <!-- Order items will be appended here -->
                </div>

                <div class="mb-3">
                    <button type="button" class="btn btn-secondary" id="addItem">Add Item</button>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Submit Order
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h3 class="card-title mb-4">Order List</h3>
            <div class="table-responsive">
                <table class="table table-hover">
  <thead class="table-light">
    <tr>
      <th>Order ID</th>
      <th>Customer</th>
      <th>Date</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody id="ordersTableBody"></tbody>
</table>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let userMap = {};

    async function loadUsers() {
        const response = await fetch("http://localhost:8001/graphql", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: `query { users { id name } }` })
        });
        const result = await response.json();
        const select = document.getElementById("customer");
        select.innerHTML = '<option value="">Select Customer</option>';
        result.data.users.forEach(user => {
            userMap[user.id] = user.name;
            select.innerHTML += `<option value="${user.id}">${user.name}</option>`;
        });
    }

    function createOrderItemRow() {
        const div = document.createElement("div");
        div.className = "row mb-3 order-item";
        div.innerHTML = `
            <div class="col-md-4">
                <input type="number" class="form-control product-id" placeholder="Product ID" required>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control quantity" placeholder="Quantity" required>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control price" placeholder="Price" required>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger remove-item">Remove</button>
            </div>
        `;
        document.getElementById("orderItems").appendChild(div);
    }

    document.getElementById("addItem").addEventListener("click", createOrderItemRow);

    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("remove-item")) {
            e.target.closest(".order-item").remove();
        }
    });

    document.getElementById("orderForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        const userId = document.getElementById("customer").value;
        const items = Array.from(document.querySelectorAll(".order-item")).map(row => ({
            product_id: parseInt(row.querySelector(".product-id").value),
            quantity: parseInt(row.querySelector(".quantity").value),
            price: parseFloat(row.querySelector(".price").value)
        }));

        const mutation = `
            mutation CreateOrder($user_id: Int!, $items: [OrderInput!]!) {
                createOrder(user_id: $user_id, items: $items) {
                    id
                    total_amount
                }
            }
        `;

        await fetch("http://localhost:8004/graphql", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: mutation, variables: { user_id: parseInt(userId), items } })
        });

        this.reset();
        document.getElementById("orderItems").innerHTML = "";
        createOrderItemRow();
        loadOrders();
    });

    async function loadOrders() {
        const query = `query { orders { id user_id order_date total_amount } }`;
        const response = await fetch("http://localhost:8004/graphql", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query })
        });
        const result = await response.json();
        const tbody = document.getElementById("ordersTableBody");
        tbody.innerHTML = "";
        result.data.orders.forEach(order => {
            const customerName = userMap[order.user_id] || 'Unknown';
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${order.id}</td>
                <td>${customerName}</td>
                <td>${new Date(order.order_date).toLocaleDateString()}</td>
                <td>${order.total_amount.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    loadUsers().then(() => {
        loadOrders();
    });
    createOrderItemRow();
</script>

{% endblock %}
